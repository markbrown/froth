; Test codegen

; Helper to dump bytecode from start to end
{ /self /end /start
  start end < {
    start peek print " " print
    start 1 + end self self!
  } { } ?!
} /dump-impl
{ /end /start start end dump-impl dump-impl! } /dump-bytecode

; Test 1: Simple integers
'{ 1 2 3 } /func
0 tree-empty! func $ codegen!
/func-addr /code-map /next-addr
"func-addr=" print func-addr print " next-addr=" print next-addr println!

; Show bytecode (should be: 0 1 0 2 0 3 2)
; push-int=0, return=2
"bytecode: " print
0 next-addr dump-bytecode!
nl!

; Test 2: With string
'{ 42 "hello" } /func2
next-addr tree-empty! func2 $ codegen!
/func-addr2 /code-map2 /next-addr2
"func-addr2=" print func-addr2 print " next-addr2=" print next-addr2 println!

"bytecode2: " print
next-addr next-addr2 dump-bytecode!
nl!

; Test 3: With operator
'{ 1 2 + } /func3
next-addr2 tree-empty! func3 $ codegen!
/func-addr3 /code-map3 /next-addr3
"func-addr3=" print func-addr3 print " next-addr3=" print next-addr3 println!

; Should be: 0 1 0 2 1 2 2
; push-int=0, op=1, +=2, return=2
"bytecode3: " print
next-addr2 next-addr3 dump-bytecode!
nl!

; Test 4: Quoted terms (test execution, not bytecode, to avoid intern ID dependency)
"quoted terms: " print
next-addr3 tree-empty! '{ 'x '/y '! '42 '"hi" } $ codegen!
/func-addr4 /code-map4 /next-addr4
[] func-addr4 close ! /r5 /r4 /r3 /r2 /r1
r1 write " " print
r2 write " " print
r3 write " " print
r4 write " " print
r5 write nl!

; Test 5: Context variables (free variables)
; Function with two free variables: x and y
'{ x y + } /func5
func5 boundness! /func5-node /func5-term
next-addr4 tree-empty! func5-term func5-node codegen!
/func-addr5 /code-map5 /next-addr5
"func-addr5=" print func-addr5 print " next-addr5=" print next-addr5 println!

; Bytecode should be: push-context 0, push-context 1, op +, return
; push-context=4, op=1, +=2, return=2
"bytecode5: " print
next-addr4 next-addr5 dump-bytecode!
nl!

; Execute with context [10 20] - should return 30
"context test: " print
[10 20] func-addr5 close ! println!

"done" println!
